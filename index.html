<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

        <title>Multicore computing in R</title>

        <meta name="author" content="Anton Lebedevich">

        <link rel="stylesheet" href="css/reveal.css">
        <link rel="stylesheet" href="css/theme/simple.css">

        <!-- Theme used for syntax highlighting of code -->
        <link rel="stylesheet" href="lib/css/zenburn.css">

        <!-- Printing and PDF exports -->
        <script>
            var link = document.createElement( 'link' );
            link.rel = 'stylesheet';
            link.type = 'text/css';
            link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
            document.getElementsByTagName( 'head' )[0].appendChild( link );
        </script>
    </head>
    <body>
        <div class="reveal">
            <div class="slides">
                <section>
                    <h1>paRallel</h1>
                    <p>
                        &copy; 2016 Anton Lebedevich
                    </p>
                </section>
                <section>
                    <h2>Anton Lebedevich:</h2>
                    <ul>
                        <li>develops scalable back-end services</li>
                        <li>solves distributed performance issues</li>
                        <li>loves time series and anomalies</li>
                        <li>blogs at <a href="http://mabrek.github.io">mabrek.github.io</a>
                    </ul>
                </section>

                <section>
                    <h2>Why?</h2>
                    <p>Your laptop has &gt; 1 cores, use them all!</p>
                </section>
                
                <section>
                    <h2>Agenda</h2>
                    <ul>
                        <li>....</li>
                    </ul>
                </section>

                <section>
                    <h2>What's available</h2>
                    <p><a href="https://cran.r-project.org/view=HighPerformanceComputing">cran.r-project.org/view=HighPerformanceComputing</a></p>
                    <ul>
                        <li><code>parallel</code> (r-base)</li>
                        <li><code>foreach</code> with <code>doParallel</code> in top 100 downloaded</li>
                        <li>local tricks here and there
                            <ul>
                                <li><code>xgboost</code> <code>nthread</code></li>
                                <li><code>data.table</code> <code>fwrite</code></li>
                                <li><code>re2r</code> <code>parallel = TRUE</code></li>
                                <li>&hellip;</li>
                            </ul>
                        </li>
                    </ul>
                </section>

                <section>
                    <h2>parallel</h2>
                    <pre><code class="R" data-trim>
library(parallel)

cores <- detectCores()

# Linux
mclapply(1:10, function(x) Sys.sleep(1), mc.cores = cores)
# yeah, that's it

# Windows
cluster <- makePSOCKcluster(cores)
parLapply(cluster, 1:10,  function(x) Sys.sleep(1))
stopCluster(cluster)
# not really, need to export data to workers too
                    </code></pre>
                </section>

                <section>
                    <h2>foreach + doParallel</h2>
                    <pre><code class="R" data-trim>
library(foreach)
library(doParallel)

registerDoParallel(detectCores())

foreach(i = 1:10) %dopar% {
    Sys.sleep(1)
}
                    </code></pre>
                </section>

                <section>
                    <h2>Profiling tools</h2>
                    <ul>
                        <li>profvis (GUI for Rprof)</li>
                        <li>perf record -F 999 --call-graph dwarf -p ...</li>
                        <li>perf record -F 999 --call-graph dwarf -a -m 512M ...</li>
                        <li>perf record -e sched:sched_stat_sleep -e sched:sched_switch -e sched:sched_process_exit --call-graph dwarf -m 512M -p ...</li>
                        <li>sysdig '(evt.type!=switch) and (syscall.type exists) and (proc.name=R)'</li>
                        <li>strace -f -p ...</li>
                    </ul>
                </section>

                <section>
                    <h2>TODO</h2>
                    highlight colors
                    white background in fullscreen (F)
                    
                    beware of mkl, openmp, parallel blas implementation
                    plyr parallel backend
                    https://cran.r-project.org/web/packages/future/index.html
                    random numbers
                    doRNG
                    ff, http://man7.org/linux/man-pages/man2/mmap.2.html MAP_SHARED
                    https://rpubs.com/Charly/206220
                    https://github.com/HenrikBengtsson/profmem
                    foreach(x=iblkcol
                    foreach .combine
                    doMC -> doParallel
                    nested loops
                    https://rpubs.com/nishantsbi/223444
                    https://www.r-bloggers.com/the-wonders-of-foreach/
                    benchr, microbenchmark
                    catch exception in forked code
                    plyr
                    http://gforge.se/2015/02/how-to-go-parallel-in-r-basics-tips/
                </section>

                <section>
                    <h2>Dangers</h2>
                    <ul>
                        <li>splitting work makes it slower</li>
                        <li>different results from single and parallel code</li>
                        <li>TODO: shared mmapped memory (ff, bigmemory)</li>
                        <li>profvis hangs</li>
                        <li>memory usage (copy, COW)</li>
                        <li>nested parallel loops</li>
                        <li>speedup is nonlinear</li>
                        <li>...</li>
                    </ul>
                </section>

                <section>
                    <h2>Further steps</h2>
                    <ul>
                        <li>doRedis</li>
                    </ul>
                </section>
                
                <section>
                    <h2>Summary</h2>
                    <ul>
                        <li>...</li>
                    </ul>
                </section>

                <section>
                    <h2>Links</h2>
                    <p><a href="http://topepo.github.io/caret/parallel-processing.html">topepo.github.io/caret/parallel-processing.html</a></p>
                    <p><a href="http://adv-r.had.co.nz/Profiling.html#parallelise">adv-r.had.co.nz/Profiling.html#parallelise</a></p>
                    <p><a href="http://gforge.se/2015/02/how-to-go-parallel-in-r-basics-tips/">gforge.se/2015/02/how-to-go-parallel-in-r-basics-tips/</a></p>
                    TODO ...
                </section>
                
                <section>
                    <h2>Q&amp;A</h2>
                    <p>
                    <p>Anton Lebedevich</p>
                    <p>mabrek@gmail.com</p>
                    <p><a href="https://twitter.com/widdoc">@widdoc</a></p>
                    <p><a href="http://mabrek.github.io">mabrek.github.io</a></p>
                    <p><a href="http://mabrek.github.io/r-multicore-presentation-2016">mabrek.github.io/r-multicore-presentation-2016</a></p>
                </section>
            </div>
        </div>

        <script src="lib/js/head.min.js"></script>
        <script src="js/reveal.js"></script>

        <script>
            // More info https://github.com/hakimel/reveal.js#configuration
            Reveal.initialize({
                controls: false,
                progress: false,
                history: true,
                center: true,
                slideNumber: 'c/t',
                transition: 'fade',
                width: 960,
                height: 700,

                // More info https://github.com/hakimel/reveal.js#dependencies
                dependencies: [
                    { src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } }
                ]
            });
        </script>
    </body>
</html>
